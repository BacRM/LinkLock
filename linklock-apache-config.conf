# --- CONFIGURATION PRODUCTION LINKLOCK.SMART-BTP.COM ---
# Apache VirtualHost pour HTTPS (port 443)

<VirtualHost *:443>
    ServerName linklock.smart-btp.com
    ServerAlias www.linklock.smart-btp.com

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/linklock.smart-btp.com.crt
    SSLCertificateKeyFile /etc/ssl/private/linklock.smart-btp.com.key
    SSLCertificateChainFile /etc/ssl/certs/linklock.smart-btp.com.ca-bundle

    # Headers de sécurité
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Proxy pour l'API backend (port 8080) - DOIT être AVANT le proxy frontend
    ProxyPass /api http://127.0.0.1:8080/api
    ProxyPassReverse /api http://127.0.0.1:8080/api

    # Proxy pour le frontend (port 8085) - Pour toutes les autres routes
    ProxyPass / http://127.0.0.1:8085/
    ProxyPassReverse / http://127.0.0.1:8085/

    # Headers essentiels
    ProxyPreserveHost On
    ProxyRequests Off
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Host "%{HTTP_HOST}e"
    RequestHeader set X-Real-IP "%{REMOTE_ADDR}e"

    # Support WebSocket pour Vite HMR (port 8085)
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "ws://127.0.0.1:8085/$1" [P,L]

    # Timeouts
    ProxyTimeout 60

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/linklock-error.log
    CustomLog ${APACHE_LOG_DIR}/linklock-access.log combined
</VirtualHost>

# Redirection HTTP vers HTTPS (port 80)
<VirtualHost *:80>
    ServerName linklock.smart-btp.com
    ServerAlias www.linklock.smart-btp.com

    Redirect permanent / https://linklock.smart-btp.com/

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/linklock-error.log
    CustomLog ${APACHE_LOG_DIR}/linklock-access.log combined
</VirtualHost>
